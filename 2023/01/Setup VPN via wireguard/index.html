<!DOCTYPE html>
<html lang=en>
<head>
    <!-- so meta -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="HandheldFriendly" content="True">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=5" />
    <meta name="description" content="Reference How To Set Up WireGuard on Ubuntu 20.04 | DigitalOcean  https:&#x2F;&#x2F;www.wireguardconfig.com&#x2F;  Secure Communication with a WireGuard VPN &amp;middot; Ultimate Security Professional Blog   TL;DR12">
<meta property="og:type" content="article">
<meta property="og:title" content="Setup VPN via WireGuard">
<meta property="og:url" content="https://blog.depoze.xyz/2023/01/Setup%20VPN%20via%20wireguard/index.html">
<meta property="og:site_name" content="CuSO4D&#39;s Electrolytic Cell">
<meta property="og:description" content="Reference How To Set Up WireGuard on Ubuntu 20.04 | DigitalOcean  https:&#x2F;&#x2F;www.wireguardconfig.com&#x2F;  Secure Communication with a WireGuard VPN &amp;middot; Ultimate Security Professional Blog   TL;DR12">
<meta property="og:locale" content="en_US">
<meta property="article:published_time" content="2023-01-31T18:05:00.000Z">
<meta property="article:modified_time" content="2023-02-10T18:21:48.000Z">
<meta property="article:author" content="CuSO4_Deposit">
<meta property="article:tag" content="Tech">
<meta property="article:tag" content="WireGuard">
<meta name="twitter:card" content="summary">
    
    
      
        
          <link rel="shortcut icon" href="/images/favicon.ico">
        
      
      
        
          <link rel="icon" type="image/png" href="/images/favicon-192x192.png" sizes="192x192">
        
      
      
        
          <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">
        
      
    
    <!-- title -->
    <title>Setup VPN via WireGuard</title>
    <!-- styles -->
	<link rel="stylesheet" href="https://cdn.bootcdn.net/ajax/libs/lxgw-wenkai-webfont/1.6.0/style.min.css" />
    
<link rel="stylesheet" href="/css/style.css">

    <!-- persian styles -->
    
    <!-- rss -->
    
    
      <link rel="alternate" href="/atom.xml" title="CuSO4D&#39;s Electrolytic Cell" type="application/atom+xml" />
    
	<!-- mathjax -->
	
		<script type="text/x-mathjax-config">
		  MathJax.Hub.Config({
			tex2jax: {
			  skipTags: ['script', 'noscript', 'style', 'textarea', 'pre'],
			  inlineMath: [['$','$']]
			}
		  });
		</script>
		<script src='https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/latest.js?config=TeX-MML-AM_CHTML' async></script>
	
	<!-- typesetting -->
	<script src="https://cdnjs.cloudflare.com/ajax/libs/pangu/4.0.7/pangu.min.js"></script>
<meta name="generator" content="Hexo 6.3.0"></head>

<body class="max-width mx-auto px3 ltr">
    
      <div id="header-post">
  <a id="menu-icon" href="#" aria-label="Menu"><i class="fas fa-bars fa-lg"></i></a>
  <a id="menu-icon-tablet" href="#" aria-label="Menu"><i class="fas fa-bars fa-lg"></i></a>
  <a id="top-icon-tablet" href="#" aria-label="Top" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;"><i class="fas fa-chevron-up fa-lg"></i></a>
  <span id="menu">
    <span id="nav">
      <ul>
        <!--
       --><li><a href="/">Home</a></li><!--
     --><!--
       --><li><a href="/about/">About</a></li><!--
     --><!--
       --><li><a href="/archives/">Articles</a></li><!--
     --><!--
       --><li><a href="/friends/">Friends</a></li><!--
     -->
      </ul>
    </span>
    <br/>
    <span id="actions">
      <ul>
        
        <li><a class="icon" aria-label="Previous post" href="/2023/03/change-font-in-cactus-theme/"><i class="fas fa-chevron-left" aria-hidden="true" onmouseover="$('#i-prev').toggle();" onmouseout="$('#i-prev').toggle();"></i></a></li>
        
        
        <li><a class="icon" aria-label="Next post" href="/2023/01/Initial%20Server%20Setup/"><i class="fas fa-chevron-right" aria-hidden="true" onmouseover="$('#i-next').toggle();" onmouseout="$('#i-next').toggle();"></i></a></li>
        
        <li><a class="icon" aria-label="Back to top" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fas fa-chevron-up" aria-hidden="true" onmouseover="$('#i-top').toggle();" onmouseout="$('#i-top').toggle();"></i></a></li>
        <li><a class="icon" aria-label="Share post" href="#"><i class="fas fa-share-alt" aria-hidden="true" onmouseover="$('#i-share').toggle();" onmouseout="$('#i-share').toggle();" onclick="$('#share').toggle();return false;"></i></a></li>
      </ul>
      <span id="i-prev" class="info" style="display:none;">Previous post</span>
      <span id="i-next" class="info" style="display:none;">Next post</span>
      <span id="i-top" class="info" style="display:none;">Back to top</span>
      <span id="i-share" class="info" style="display:none;">Share post</span>
    </span>
    <br/>
    <div id="share" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=https://blog.depoze.xyz/2023/01/Setup%20VPN%20via%20wireguard/"><i class="fab fa-facebook " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=https://blog.depoze.xyz/2023/01/Setup%20VPN%20via%20wireguard/&text=Setup VPN via WireGuard"><i class="fab fa-twitter " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=https://blog.depoze.xyz/2023/01/Setup%20VPN%20via%20wireguard/&title=Setup VPN via WireGuard"><i class="fab fa-linkedin " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=https://blog.depoze.xyz/2023/01/Setup%20VPN%20via%20wireguard/&is_video=false&description=Setup VPN via WireGuard"><i class="fab fa-pinterest " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=Setup VPN via WireGuard&body=Check out this article: https://blog.depoze.xyz/2023/01/Setup%20VPN%20via%20wireguard/"><i class="fas fa-envelope " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=https://blog.depoze.xyz/2023/01/Setup%20VPN%20via%20wireguard/&title=Setup VPN via WireGuard"><i class="fab fa-get-pocket " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=https://blog.depoze.xyz/2023/01/Setup%20VPN%20via%20wireguard/&title=Setup VPN via WireGuard"><i class="fab fa-reddit " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=https://blog.depoze.xyz/2023/01/Setup%20VPN%20via%20wireguard/&title=Setup VPN via WireGuard"><i class="fab fa-stumbleupon " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=https://blog.depoze.xyz/2023/01/Setup%20VPN%20via%20wireguard/&title=Setup VPN via WireGuard"><i class="fab fa-digg " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=https://blog.depoze.xyz/2023/01/Setup%20VPN%20via%20wireguard/&name=Setup VPN via WireGuard&description="><i class="fab fa-tumblr " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://news.ycombinator.com/submitlink?u=https://blog.depoze.xyz/2023/01/Setup%20VPN%20via%20wireguard/&t=Setup VPN via WireGuard"><i class="fab fa-hacker-news " aria-hidden="true"></i></a></li>
</ul>

    </div>
    <div id="toc">
      <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#Reference"><span class="toc-number">1.</span> <span class="toc-text">Reference</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#TL-DR"><span class="toc-number">2.</span> <span class="toc-text">TL;DR</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Step-1-%E2%80%94-Installing-WireGuard-and-Generating-a-Key-Pair"><span class="toc-number">3.</span> <span class="toc-text">Step 1 — Installing WireGuard and Generating a Key Pair</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Step-2-a-%E2%80%94-Choosing-an-IPv4-Range"><span class="toc-number">3.1.</span> <span class="toc-text">Step 2(a) — Choosing an IPv4 Range</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Step-2-b-%E2%80%94-Choosing-an-IPv6-Range"><span class="toc-number">3.2.</span> <span class="toc-text">Step 2(b) — Choosing an IPv6 Range</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Step-3-%E2%80%94-Creating-a-WireGuard-Server-Configuration"><span class="toc-number">4.</span> <span class="toc-text">Step 3 — Creating a WireGuard Server Configuration</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Step-4-%E2%80%94-Adjusting-the-WireGuard-Server%E2%80%99s-Network-Configuration"><span class="toc-number">5.</span> <span class="toc-text">Step 4 — Adjusting the WireGuard Server’s Network Configuration</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Step-5-%E2%80%94-Configuring-the-WireGuard-Server%E2%80%99s-Firewall"><span class="toc-number">6.</span> <span class="toc-text">Step 5 — Configuring the WireGuard Server’s Firewall</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Step-6-%E2%80%94-Starting-the-WireGuard-Server"><span class="toc-number">7.</span> <span class="toc-text">Step 6 — Starting the WireGuard Server</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Step-7-%E2%80%94-Configuring-a-WireGuard-Peer"><span class="toc-number">8.</span> <span class="toc-text">Step 7 — Configuring a WireGuard Peer</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Creating-the-WireGuard-Peer%E2%80%99s-Key-Pair"><span class="toc-number">8.1.</span> <span class="toc-text">Creating the WireGuard Peer’s Key Pair</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Creating-the-WireGuard-Peer%E2%80%99s-Configuration-File"><span class="toc-number">8.2.</span> <span class="toc-text">Creating the WireGuard Peer’s Configuration File</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Optional-Configuring-a-Peer-to-Route-All-Traffic-Over-the-Tunnel"><span class="toc-number">8.3.</span> <span class="toc-text">(Optional) Configuring a Peer to Route All Traffic Over the Tunnel</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Optional-Configuring-the-WireGuard-Peer%E2%80%99s-DNS-Resolvers"><span class="toc-number">8.4.</span> <span class="toc-text">(Optional) Configuring the WireGuard Peer’s DNS Resolvers</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Step-8-%E2%80%94-Adding-the-Peer%E2%80%99s-Public-Key-to-the-WireGuard-Server"><span class="toc-number">9.</span> <span class="toc-text">Step 8 — Adding the Peer’s Public Key to the WireGuard Server</span></a></li></ol>
    </div>
  </span>
</div>

    
    <div class="content index py4">
        
        <article class="post" itemscope itemtype="http://schema.org/BlogPosting">
  <header>
    
    <h1 class="posttitle" itemprop="name headline">
        Setup VPN via WireGuard
    </h1>



    <div class="meta">
      <span class="author" itemprop="author" itemscope itemtype="http://schema.org/Person">
        <span itemprop="name">CuSO4_Deposit</span>
      </span>
      
    <div class="postdate">
      
        <time datetime="2023-01-31T18:05:00.000Z" itemprop="datePublished">2023-01-31</time>
        
        (Updated: <time datetime="2023-02-10T18:21:48.000Z" itemprop="dateModified">2023-02-10</time>)
        
      
    </div>


      

      
    <div class="article-tag">
        <i class="fas fa-tag"></i>
        <a class="tag-link-link" href="/tags/Tech/" rel="tag">Tech</a>, <a class="tag-link-link" href="/tags/WireGuard/" rel="tag">WireGuard</a>
    </div>


    </div>
  </header>
  

  <div class="content" itemprop="articleBody">
    <h2 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h2><ul>
<li><p><a target="_blank" rel="noopener" href="https://www.digitalocean.com/community/tutorials/how-to-set-up-wireguard-on-ubuntu-20-04">How To Set Up WireGuard on Ubuntu 20.04 | DigitalOcean</a></p>
</li>
<li><p><a target="_blank" rel="noopener" href="https://www.wireguardconfig.com/">https://www.wireguardconfig.com/</a></p>
</li>
<li><p><a target="_blank" rel="noopener" href="https://ultimatesecurity.pro/post/wireguard/#:~:text=Delete%20the%20WireGuard%20interface%20During%20your%20tests%20you,wg.%20Let%E2%80%99s%20execute%20once%20again%20the%20command%20wg.">Secure Communication with a WireGuard VPN &amp;middot; Ultimate Security Professional Blog</a></p>
</li>
</ul>
<h2 id="TL-DR"><a href="#TL-DR" class="headerlink" title="TL;DR"></a>TL;DR</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"># server.conf</span><br><span class="line">[Interface]</span><br><span class="line">Address = 10.6.0.1/24</span><br><span class="line">PostUp = ufw route allow in on wg0 out on eth0</span><br><span class="line">PostUp = iptables -A FORWARD -i %i -j ACCEPT; iptables -t nat -A POSTROUTING -o eth0 -j MASQUERADE</span><br><span class="line">PreDown = ufw route delete allow in on wg0 out on eth0</span><br><span class="line">PreDown = iptables -D FORWARD -i %i -j ACCEPT; iptables -t nat -D POSTROUTING -o eth0 -j MASQUERADE</span><br><span class="line">ListenPort = 51820</span><br><span class="line">PrivateKey = &lt;server generated private key&gt;</span><br><span class="line"></span><br><span class="line">[Peer]</span><br><span class="line">PublicKey = &lt;client1 generated public key&gt;</span><br><span class="line">AllowedIPs = 10.6.0.2/32</span><br><span class="line"></span><br><span class="line">[Peer]</span><br><span class="line">PublicKey = &lt;client2 generated public key&gt;</span><br><span class="line">AllowedIPs = 10.6.0.3/32</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># client1.conf</span><br><span class="line">[Interface]</span><br><span class="line">PrivateKey = &lt;client1 generated private key&gt;</span><br><span class="line">Address = 10.6.0.2/24</span><br><span class="line">DNS = 208.67.222.222</span><br><span class="line"></span><br><span class="line">[Peer]</span><br><span class="line">PublicKey = &lt;server generated public key&gt;</span><br><span class="line">AllowedIPs = 0.0.0.0/0</span><br><span class="line">Endpoint = &lt;server_ip&gt;:51820</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># client2.conf</span><br><span class="line">[Interface]</span><br><span class="line">PrivateKey = &lt;client2 generated private key&gt;</span><br><span class="line">Address = 10.6.0.3/24</span><br><span class="line">DNS = 208.67.222.222</span><br><span class="line"></span><br><span class="line">[Peer]</span><br><span class="line">PublicKey = &lt;server generated public key&gt;</span><br><span class="line">AllowedIPs = 0.0.0.0/0</span><br><span class="line">Endpoint = &lt;server_ip&gt;:51820</span><br></pre></td></tr></table></figure>

<ul>
<li><p>Server side</p>
<ul>
<li><p>Interface Address can be randomly picked</p>
</li>
<li><p>Peer AllowedIPs should be correspondent to client side, with mask <code>/32</code></p>
</li>
</ul>
</li>
<li><p>Client sides</p>
<ul>
<li><p>Interface Address is in the subnet of server side interface address</p>
</li>
<li><p>Interface Addresses of different clients must not intersect</p>
</li>
<li><p>Interface Address has mask <code>/24</code>.</p>
</li>
</ul>
</li>
</ul>
<h2 id="Step-1-—-Installing-WireGuard-and-Generating-a-Key-Pair"><a href="#Step-1-—-Installing-WireGuard-and-Generating-a-Key-Pair" class="headerlink" title="Step 1 — Installing WireGuard and Generating a Key Pair"></a>Step 1 — Installing WireGuard and Generating a Key Pair</h2><p>The first step in this tutorial is to install WireGuard on your<br>server. To start off, update your WireGuard Server’s package index and<br>install WireGuard using the following commands. You may be prompted to<br>provide your sudo user’s password if this is the first time you’re using<br> <code>sudo</code> in this session:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo apt update</span><br><span class="line">sudo apt install wireguard</span><br></pre></td></tr></table></figure>

<p>Now that you have WireGuard installed, the next step is to generate a<br>private and public keypair for the server. You’ll use the built-in <code>wg genkey</code> and <code>wg pubkey</code> commands to create the keys, and then add the private key to WireGuard’s configuration file.</p>
<p>You will also need to change the permissions on the key that you just created using the <code>chmod</code> command, since by default the file is readable by any user on your server.</p>
<p>Create the private key for WireGuard and change its permissions using the following commands:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">wg genkey | sudo tee /etc/wireguard/private.key</span><br><span class="line">sudo chmod go= /etc/wireguard/private.key</span><br></pre></td></tr></table></figure>

<p>The <code>sudo chmod go=...</code> command removes any permissions on the file for users and groups other than the root user to ensure that only it can access the private key.</p>
<p>You should receive a single line of <code>base64</code> encoded output, which is the private key. A copy of the output is also stored in the <code>/etc/wireguard/private.key</code> file for future reference by the <code>tee</code> portion of the command. Carefully make a note of the private key that is output since you’ll need to add it to WireGuard’s configuration file<br>later in this section.</p>
<p>The next step is to create the corresponding public key, which is<br>derived from the private key. Use the following command to create the<br>public key file:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo cat /etc/wireguard/private.key | wg pubkey | sudo tee /etc/wireguard/public.key</span><br></pre></td></tr></table></figure>

<p>This command consists of three individual commands that are chained together using the <code>|</code> (pipe) operator:</p>
<ul>
<li><code>sudo cat /etc/wireguard/private.key</code>: this command reads the private key file and outputs it to the <a target="_blank" rel="noopener" href="https://www.digitalocean.com/community/tutorials/an-introduction-to-linux-i-o-redirection#standard-output">standard output</a> stream.</li>
<li><code>wg pubkey</code>: the second command takes the output from the first command as its <a target="_blank" rel="noopener" href="https://www.digitalocean.com/community/tutorials/an-introduction-to-linux-i-o-redirection#standard-input">standard input</a> and processes it to generate a public key.</li>
<li><code>sudo tee /etc/wireguard/public.key</code>: the final command takes the output of the public key generation command and redirects it into the file named <code>/etc/wireguard/public.key</code>.</li>
</ul>
<p>When you run the command you will again receive a single line of <code>base64</code> encoded output, which is the public key for your WireGuard Server. Copy it somewhere for reference, since you will need to distribute the public key to any peer that connects to the server.</p>
<h3 id="Step-2-a-—-Choosing-an-IPv4-Range"><a href="#Step-2-a-—-Choosing-an-IPv4-Range" class="headerlink" title="Step 2(a) — Choosing an IPv4 Range"></a>Step 2(a) — Choosing an IPv4 Range</h3><p>10.8.0.1&#x2F;24 for example</p>
<h3 id="Step-2-b-—-Choosing-an-IPv6-Range"><a href="#Step-2-b-—-Choosing-an-IPv6-Range" class="headerlink" title="Step 2(b) — Choosing an IPv6 Range"></a>Step 2(b) — Choosing an IPv6 Range</h3><p>This server doesn’t have an ipv6 address.</p>
<p>Generate method: <a target="_blank" rel="noopener" href="https://www.rfc-editor.org/rfc/rfc4193#section-3">RFC 4193</a></p>
<h2 id="Step-3-—-Creating-a-WireGuard-Server-Configuration"><a href="#Step-3-—-Creating-a-WireGuard-Server-Configuration" class="headerlink" title="Step 3 — Creating a WireGuard Server Configuration"></a>Step 3 — Creating a WireGuard Server Configuration</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo vim /etc/wireguard/wg0.conf</span><br></pre></td></tr></table></figure>

<p>Add the following lines to the file, substituting your private key in place of the highlighted <code>base64_encoded_private_key_goes_here</code> value, and the IP address(es) on the <code>Address</code> line. You can also change the <code>ListenPort</code> line if you would like WireGuard to be available on a different port:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"># /etc/wireguard/wg0.conf</span><br><span class="line">[Interface]</span><br><span class="line">PrivateKey = base64_encoded_private_key_goes_here</span><br><span class="line">Address = 10.8.0.1/24</span><br><span class="line">ListenPort = 51820</span><br><span class="line"># SaveConfig = true</span><br></pre></td></tr></table></figure>

<p>The <code>SaveConfig</code> line ensures that when a WireGuard interface is shutdown, any changes will get saved to the configuration file.</p>
<p><strong>When using multi peers, disable SaveConfig in case when some peer is not connected to the tunnel, wg deletes its corresponding public key.</strong></p>
<p>Save and close the <code>/etc/wireguard/wg0.conf</code> file.</p>
<h2 id="Step-4-—-Adjusting-the-WireGuard-Server’s-Network-Configuration"><a href="#Step-4-—-Adjusting-the-WireGuard-Server’s-Network-Configuration" class="headerlink" title="Step 4 — Adjusting the WireGuard Server’s Network Configuration"></a>Step 4 — Adjusting the WireGuard Server’s Network Configuration</h2><p>If you are using WireGuard to connect a peer to the WireGuard Server in order to access services on the <strong>server only</strong>, then you do not need to complete this section. If you would like to route your WireGuard Peer’s Internet traffic through the WireGuard<br>Server then you will need to configure IP forwarding by following this section of the tutorial.</p>
<p>To configure forwarding, open the <code>/etc/sysctl.conf</code> file using <code>vim</code> or your preferred editor:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo vim /etc/sysctl.conf</span><br></pre></td></tr></table></figure>

<p>If you are using IPv4 with WireGuard, add the following line at the bottom of the file:</p>
<p>&#x2F;etc&#x2F;sysctl.conf</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">net.ipv4.ip_forward=1</span><br></pre></td></tr></table></figure>

<p>If you are using IPv6 with WireGuard, add this line at the bottom of the file:</p>
<p>&#x2F;etc&#x2F;sysctl.conf</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">net.ipv6.conf.all.forwarding=1</span><br></pre></td></tr></table></figure>

<p>If you are using both IPv4 and IPv6, ensure that you include both lines. Save and close the file when you are finished.</p>
<p>To read the file and load the new values for your current terminal session, run:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo sysctl -p</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Outputnet.ipv6.conf.all.forwarding = 1</span><br><span class="line">net.ipv4.ip_forward = 1</span><br></pre></td></tr></table></figure>

<p>Now your WireGuard Server will be able to forward incoming traffic from the virtual VPN ethernet device to others on the server, and from there to the public Internet. Using this configuration will allow you to route all web traffic from your WireGuard Peer via your server’s IP address, and your client’s public IP address will be effectively hidden.</p>
<p>However, before traffic can be routed via your server correctly, you will need to configure some firewall rules. These rules will ensure that traffic to and from your WireGuard Server and Peers flows properly.</p>
<h2 id="Step-5-—-Configuring-the-WireGuard-Server’s-Firewall"><a href="#Step-5-—-Configuring-the-WireGuard-Server’s-Firewall" class="headerlink" title="Step 5 — Configuring the WireGuard Server’s Firewall"></a>Step 5 — Configuring the WireGuard Server’s Firewall</h2><p>In this section you will edit the WireGuard Server’s configuration to add firewall rules that will ensure traffic to and from the server and clients is routed correctly. As with the previous section, skip this step if you are only using your WireGuard VPN for a machine to machine connection to access resources that are restricted to your VPN.</p>
<p>To allow WireGuard VPN traffic through the Server’s firewall, you’ll need to enable masquerading, which is an iptables concept that provides on-the-fly dynamic network address translation (NAT) to correctly route client connections.</p>
<p>First find the public network interface of your WireGuard Server using the <code>ip route</code> sub-command:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ip route list default</span><br></pre></td></tr></table></figure>

<p>The public interface is the string found within this command’s output that follows the word “dev”. For example, this result shows the interface named <code>eth0</code>, which is highlighted below:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">default via 107.173.xx.yy dev eth0 onlink</span><br></pre></td></tr></table></figure>

<p>Note your device’s name since you will add it to the <code>iptables</code> rules in the next step.</p>
<p>To add firewall rules to your WireGuard Server, open the <code>/etc/wireguard/wg0.conf</code> file with <code>vim</code> or your preferred editor again.</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo vim /etc/wireguard/wg0.conf</span><br></pre></td></tr></table></figure>

<p><strong>The configuration of DigitalOcean doesn’t work for me, this is the modified version that works:</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">PostUp = ufw route allow in on wg0 out on eth0</span><br><span class="line">PostUp = iptables -A FORWARD -i %i -j ACCEPT; iptables -t nat -A POSTROUTING -o eth0 -j MASQUERADE</span><br><span class="line">PreDown = ufw route delete allow in on wg0 out on eth0</span><br><span class="line">PreDown = iptables -D FORWARD -i %i -j ACCEPT; iptables -t nat -D POSTROUTING -o eth0 -j MASQUERADE</span><br></pre></td></tr></table></figure>

<p>The <code>PostUp</code> lines will run when the WireGuard Server starts the virtual VPN tunnel. In the example here, it will add three <code>ufw</code> and <code>iptables</code> rules:</p>
<ul>
<li><code>ufw route allow in on wg0 out on eth0</code> - This rule will allow forwarding IPv4 and IPv6 traffic that comes in on the <code>wg0</code> VPN interface to the <code>eth0</code> network interface on the server. It works in conjunction with the <code>net.ipv4.ip_forward</code> and <code>net.ipv6.conf.all.forwarding</code> sysctl values that you configured in the previous section.</li>
<li><code>iptables -t nat -I POSTROUTING -o eth0 -j MASQUERADE</code> - This rule configures masquerading, and rewrites IPv4 traffic that comes in on the <code>wg0</code> VPN interface to make it appear like it originates directly from the WireGuard Server’s public IPv4 address.</li>
<li><code>ip6tables -t nat -I POSTROUTING -o eth0 -j MASQUERADE</code> - This rule configures masquerading, and rewrites IPv6 traffic that comes in on the <code>wg0</code> VPN interface to make it appear like it originates directly from the WireGuard Server’s public IPv6 address.</li>
</ul>
<p>The <code>PreDown</code> rules run when the WireGuard Server stops the virtual VPN tunnel. These rules are the inverse of the <code>PostUp</code> rules, and function to undo the forwarding and masquerading rules for the VPN interface when the VPN is stopped.</p>
<p>In both cases, edit the configuration to include or exclude the IPv4 and IPv6 rules that are appropriate for your VPN. For example, if you are just using IPv4, then you can exclude the lines with the <code>ip6tables</code> commands.</p>
<p>Conversely, if you are only using IPv6, then edit the configuration to only include the <code>ip6tables</code> commands. The <code>ufw</code> lines should exist for any combination of IPv4 and IPv6 networks. Save and close the file when you are finished.</p>
<p>The last part of configuring the firewall on your WireGuard Server is to allow traffic to and from the WireGuard UDP port itself. If you did not change the port in the server’s <code>/etc/wireguard/wg0.conf</code> file, the port that you will open is <code>51820</code>. If you chose a different port when editing the configuration be sure to substitute it in the following UFW command.</p>
<p>In case you forgot to open the SSH port when following the prerequisite tutorial, add it here too:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo ufw allow 51820/udp</span><br><span class="line">sudo ufw allow OpenSSH</span><br></pre></td></tr></table></figure>

<p><strong>Note</strong>: If you are using a different firewall or have customized your UFW configuration, you may need to add additional firewall rules. For example, if you decide to tunnel all of your network traffic over the VPN connection, you will need to ensure that port <code>53</code> traffic is allowed for DNS requests, and ports like <code>80</code> and <code>443</code> for HTTP and HTTPS traffic respectively. If there are other protocols that you are using over the VPN then you will need to add rules for them as well.</p>
<p>After adding those rules, disable and re-enable UFW to restart it and load the changes from all of the files you’ve modified:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo ufw disable</span><br><span class="line">sudo ufw enable</span><br></pre></td></tr></table></figure>

<h2 id="Step-6-—-Starting-the-WireGuard-Server"><a href="#Step-6-—-Starting-the-WireGuard-Server" class="headerlink" title="Step 6 — Starting the WireGuard Server"></a>Step 6 — Starting the WireGuard Server</h2><p>WireGuard can be configured to run as a <code>systemd</code> service using its built-in <code>wg-quick</code> script. While you could manually use the <code>wg</code> command to create the tunnel every time you want to use the VPN, doing so is a manual process that becomes repetitive and error prone. Instead, you can use <code>systemctl</code> to manage the tunnel with the help of the <code>wg-quick</code> script.</p>
<p>Using a <code>systemd</code> service means that you can configure WireGuard to start up at boot so that you can connect to your VPN at any time as long as the server is running. To do this, enable the <code>wg-quick</code> service for the <code>wg0</code> tunnel that you’ve defined by adding it to <code>systemctl</code>:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo systemctl enable wg-quick@wg0.service</span><br></pre></td></tr></table></figure>

<p>Notice that the command specifies the name of the tunnel <code>wg0</code> device name as a part of the service name. This name maps to the <code>/etc/wireguard/wg0.conf</code> configuration file. This approach to naming means that you can create as many separate VPN tunnels as you would like using your server.</p>
<p>For example, you could have a tunnel device and name of <code>prod</code> and its configuration file would be <code>/etc/wireguard/prod.conf</code>. Each tunnel configuration can contain different IPv4, IPv6, and client firewall settings. In this way you can support multiple different peer connections, each with their own unique IP addresses and routing rules.</p>
<p>Now start the service:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo systemctl start wg-quick@wg0.service</span><br></pre></td></tr></table></figure>

<p>Double check that the WireGuard service is active with the following command. You should see <code>active (running)</code> in the output:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo systemctl status wg-quick@wg0.service</span><br></pre></td></tr></table></figure>

<h2 id="Step-7-—-Configuring-a-WireGuard-Peer"><a href="#Step-7-—-Configuring-a-WireGuard-Peer" class="headerlink" title="Step 7 — Configuring a WireGuard Peer"></a>Step 7 — Configuring a WireGuard Peer</h2><p>Configuring a WireGuard peer is similar to setting up the WireGuard<br>Server. Once you have the client software installed, you’ll generate a<br>public and private key pair, decide on an IP address or addresses for<br>the peer, define a configuration file for the peer, and then start the<br>tunnel using the <code>wg-quick</code> script.</p>
<p>You can add as many peers as you like to your VPN by generating a key<br> pair and configuration using the following steps. If you add multiple<br>peers to the VPN be sure to keep track of their private IP addresses to<br>prevent collisions.</p>
<p>To configure the WireGuard Peer, ensure that you have the WireGuard package installed using the following <code>apt</code> commands. On the WireGuard peer run:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo apt update</span><br><span class="line">sudo apt install wireguard</span><br></pre></td></tr></table></figure>

<h3 id="Creating-the-WireGuard-Peer’s-Key-Pair"><a href="#Creating-the-WireGuard-Peer’s-Key-Pair" class="headerlink" title="Creating the WireGuard Peer’s Key Pair"></a>Creating the WireGuard Peer’s Key Pair</h3><p>Next, you’ll need to generate the key pair on the peer using the same steps as you used on the server. From your local machine or remote server that will serve as peer, proceed and create the private key for the peer using the following commands:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">wg genkey | sudo tee /etc/wireguard/private.key</span><br><span class="line">sudo chmod go= /etc/wireguard/private.key</span><br></pre></td></tr></table></figure>

<p>Again you will receive a single line of <code>base64</code> encoded output, which is the private key. A copy of the output is also stored in the <code>/etc/wireguard/private.key</code>. Carefully make a note of the private key that is output since you’ll need to add it to WireGuard’s configuration file later in this section.</p>
<p>Next use the following command to create the public key file:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo cat /etc/wireguard/private.key | wg pubkey | sudo tee /etc/wireguard/public.key</span><br></pre></td></tr></table></figure>

<p>You will again receive a single line of <code>base64</code> encoded output, which is the public key for your WireGuard Peer. Copy it somewhere for reference, since you will need to distribute the public key to the WireGuard Server in order to establish an encrypted<br>connection.</p>
<h3 id="Creating-the-WireGuard-Peer’s-Configuration-File"><a href="#Creating-the-WireGuard-Peer’s-Configuration-File" class="headerlink" title="Creating the WireGuard Peer’s Configuration File"></a>Creating the WireGuard Peer’s Configuration File</h3><p>Now that you have a key pair, you can create a configuration file for<br> the peer that contains all the information that it needs to establish a<br> connection to the WireGuard Server.</p>
<p>You will need a few pieces of information for the configuration file:</p>
<ul>
<li><p>The <code>base64</code> encoded private key that you generated on the peer.</p>
</li>
<li><p>The IPv4 and IPv6 address ranges that you defined on the WireGuard Server.</p>
</li>
<li><p>The <code>base64</code> encoded public key from the WireGuard Server.</p>
</li>
<li><p>The public IP address and port number of the WireGuard Server.<br>Usually this will be the IPv4 address, but if your server has an IPv6<br>address and your client machine has an IPv6 connection to the internet<br>you can use this instead of IPv4.</p>
</li>
</ul>
<p>With all this information at hand, open a new <code>/etc/wireguard/wg0.conf</code> file on the WireGuard Peer machine using <code>vim</code> or your preferred editor:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo vim /etc/wireguard/wg0.conf</span><br></pre></td></tr></table></figure>

<p>Add the following lines to the file, substituting in the various data into the highlighted sections as required:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[Interface]</span><br><span class="line">PrivateKey = base64_encoded_peer_private_key_goes_here</span><br><span class="line">Address = 10.8.0.2/24</span><br><span class="line"></span><br><span class="line">[Peer]</span><br><span class="line">PublicKey = U9uE2kb/nrrzsEU58GD3pKFU3TLYDMCbetIsnV8eeFE=</span><br><span class="line">AllowedIPs = 10.8.0.0/24</span><br><span class="line">Endpoint = 203.0.113.1:51820</span><br></pre></td></tr></table></figure>

<p>Notice how the first <code>Address</code> line uses an IPv4 address from the <code>10.8.0.0/24</code> subnet that you chose earlier. This IP address can be anything in the subnet as long as it is different from the server’s IP. Incrementing addresses by 1 each time you add a peer is generally the easiest way to allocate IPs.</p>
<p>Likewise, notice how the second <code>Address</code> line uses an IPv6 address from the subnet that you generated earlier, and increments the server’s address by one. Again, any IP in the range is valid if you decide to use a different address.</p>
<p>The other notable part of the file is the last <code>AllowedIPs</code> line. These two IPv4 and IPv6 ranges instruct the peer to only send traffic over the VPN if the destination system has an IP address in either range. Using the <code>AllowedIPs</code> directive, you can restrict the VPN on the peer to only connect to other peers and services on the VPN, or you can configure the setting to tunnel all traffic over the VPN and use the WireGuard Server as a gateway.</p>
<p>If you are only using IPv4, then omit the trailing <code>fd0d:86fa:c3bc::/64</code> range (including the <code>,</code> comma). Conversely, if you are only using IPv6, then only include the <code>fd0d:86fa:c3bc::/64</code> prefix and leave out the <code>10.8.0.0/24</code> IPv4 range.</p>
<p>In both cases, if you would like to send all your peer’s traffic over the VPN and use the WireGuard Server as a gateway for all traffic, then you can use <code>0.0.0.0/0</code>, which represents the entire IPv4 address space, and <code>::/0</code> for the entire IPv6 address space.</p>
<h3 id="Optional-Configuring-a-Peer-to-Route-All-Traffic-Over-the-Tunnel"><a href="#Optional-Configuring-a-Peer-to-Route-All-Traffic-Over-the-Tunnel" class="headerlink" title="(Optional) Configuring a Peer to Route All Traffic Over the Tunnel"></a>(Optional) Configuring a Peer to Route All Traffic Over the Tunnel</h3><p><strong>I did not configure this but it still works.</strong></p>
<p>If you have opted to route all of the peer’s traffic over the tunnel using the <code>0.0.0.0/0</code> or <code>::/0</code> routes and the peer is a remote system, then you will need to complete<br>the steps in this section. If your peer is a local system then it is<br>best to skip this section.</p>
<p>For remote peers that you access via SSH or some other protocol using<br> a public IP address, you will need to add some extra rules to the<br>peer’s <code>wg0.conf</code> file. These rules will ensure that you can<br>still connect to the system from outside of the tunnel when it is<br>connected. Otherwise, when the tunnel is established, all traffic that<br>would normally be handled on the public network interface will not be<br>routed correctly to bypass the <code>wg0</code> tunnel interface, leading to an inaccessible remote system.</p>
<p>First, you’ll need to determine the IP address that the system uses as its default gateway. Run the following <code>ip route</code> command:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ip route list table main default</span><br></pre></td></tr></table></figure>

<p>You will receive output like the following:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">default via 203.0.113.1 dev eth0 proto static</span><br></pre></td></tr></table></figure>

<p>Note the gateway’s highlighted IP address <code>203.0.113.1</code> for later use, and device <code>eth0</code>. Your device name may be different. If so, substitute it in place of <code>eth0</code> in the following commands.</p>
<p>Next find the public IP for the system by examining the device with the <code>ip address show</code> command:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ip -brief address show eth0</span><br></pre></td></tr></table></figure>

<p>You will receive output like the following:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Outputeth0             UP             203.0.113.5/20 10.20.30.40/16 2604:a880:400:d1::3d3:6001/64 fe80::68d5:beff:feff:974c/64</span><br></pre></td></tr></table></figure>

<p>In this example output, the highlighted <code>203.0.113.5</code> IP (without the trailing <code>/20</code>) is the public address that is assigned to the <code>eth0</code> device that you’ll need to add to the WireGuard configuration.</p>
<p>Now open the WireGuard Peer’s <code>/etc/wireguard/wg0.conf</code> file with <code>nano</code> or your preferred editor.</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo nano /etc/wireguard/wg0.conf</span><br></pre></td></tr></table></figure>

<p>Before the <code>[Peer]</code> line, add the following 4 lines:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">PostUp = ip rule add table 200 from 203.0.113.5</span><br><span class="line">PostUp = ip route add table 200 default via 203.0.113.1</span><br><span class="line">PreDown = ip rule delete table 200 from 203.0.113.5</span><br><span class="line">PreDown = ip route delete table 200 default via 203.0.113.1</span><br><span class="line"></span><br><span class="line">[Peer]</span><br><span class="line">. . .</span><br></pre></td></tr></table></figure>

<p>These lines will create a custom routing rule, and add a custom route<br> to ensure that public traffic to the system uses the default gateway.</p>
<ul>
<li><code>PostUp = ip rule add table 200 from 203.0.113.5</code> - This command creates a rule that checks for any routing entries in the table numbered <code>200</code> when the IP matches the system’s public <code>203.0.113.5</code> address.</li>
<li><code>PostUp = ip route add table 200 default via 203.0.113.1</code> - This command ensures that any traffic being processed by the <code>200</code> table will use the <code>203.0.113.1</code> gateway for routing, instead of the WireGuard interface.</li>
</ul>
<p>The <code>PreDown</code> lines remove the custom rule and route when the tunnel is shutdown.</p>
<p>Note: The table number <code>200</code> is arbitrary when constructing these rules. You can use a value between 2 and 252, or you can use a custom name by adding a label to the <code>/etc/iproute2/rt_tables</code> file and then referring to the name instead of the numeric value.</p>
<p>For more information about how routing tables work in Linux visit the <a target="_blank" rel="noopener" href="http://linux-ip.net/html/routing-tables.html">Routing Tables Section</a> of the <a target="_blank" rel="noopener" href="http://linux-ip.net/html/index.html">Guide to IP Layer Network Administration with Linux</a>.</p>
<p>If you are routing all the peer’s traffic over the VPN, ensure that you have configured the correct <code>sysctl</code> and <code>iptables</code> rules on the WireGuard Server in <a target="_blank" rel="noopener" href="https://www.digitalocean.com/community/tutorials/how-to-set-up-wireguard-on-ubuntu-20-04#step-4-%E2%80%94-adjusting-the-wireguard-server-39-s-network-configuration">Step 4 — Adjusting the WireGuard Server’s Network Configuration</a> and <a target="_blank" rel="noopener" href="https://www.digitalocean.com/community/tutorials/how-to-set-up-wireguard-on-ubuntu-20-04#step-5-%E2%80%94-configuring-the-wireguard-server%E2%80%99s-firewall">Step 5 — Configuring the WireGuard Server’s Firewall</a>.</p>
<h3 id="Optional-Configuring-the-WireGuard-Peer’s-DNS-Resolvers"><a href="#Optional-Configuring-the-WireGuard-Peer’s-DNS-Resolvers" class="headerlink" title="(Optional) Configuring the WireGuard Peer’s DNS Resolvers"></a>(Optional) Configuring the WireGuard Peer’s DNS Resolvers</h3><p><strong>I use OpenDNS(208.67.222.222) as DNS server because resolvectl dns didn’t give a valid output.</strong></p>
<p>If you are using the WireGuard Server as a VPN gateway for all your peer’s traffic, you will need to add a line to the <code>[Interface]</code> section that specifies DNS resolvers. If you do not add this setting,<br>then your DNS requests may not be secured by the VPN, or they might be<br>revealed to your Internet Service Provider or other third parties.</p>
<p>If you are only using WireGuard to access resources on the VPN<br>network or in a peer-to-peer configuration then you can skip this<br>section.</p>
<p>To add DNS resolvers to your peer’s configuration, first determine<br>which DNS servers your WireGuard Server is using. Run the following<br>command on the <strong>WireGuard Server</strong>, substituting in your ethernet device name in place of <code>eth0</code> if it is different from this example:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">resolvectl dns eth0</span><br></pre></td></tr></table></figure>

<p>You should receive output like the following:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">OutputLink 2 (eth0): 67.207.67.2 67.207.67.3 2001:4860:4860::8844 2001:4860:4860::8888</span><br></pre></td></tr></table></figure>

<p>The IP addresses that are output are the DNS resolvers that the<br>server is using. You can choose to use any or all of them, or only IPv4<br>or IPv6 depending on your needs. Make a note of the resolvers that you<br>will use.</p>
<p>Next you will need to add your chosen resolvers to the WireGuard Peer’s configuration file. Back on the <strong>WireGuard Peer</strong>, open <code>/etc/wireguard/wg0.conf</code> file using <code>nano</code> or your preferred editor:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo nano /etc/wireguard/wg0.conf</span><br></pre></td></tr></table></figure>

<p>Before the <code>[Peer]</code> line, add the following:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">DNS = 67.207.67.2 2001:4860:4860::8844</span><br><span class="line"></span><br><span class="line">[Peer]</span><br><span class="line">. . .</span><br></pre></td></tr></table></figure>

<p>Again, depending on your preference or requirements for IPv4 and IPv6, you can edit the list according to your needs.</p>
<p>Once you are connected to the VPN in the following step, you can<br>check that you are sending DNS queries over the VPN by using a site like<br> <a target="_blank" rel="noopener" href="https://www.dnsleaktest.com/">DNS leak test.com</a>.</p>
<p>You can also check that your peer is using the configured resolvers with the <code>resolvectl dns</code> command like you ran on the server. You should receive output like the<br>following, showing the DNS resolvers that you configured for the VPN<br>tunnel:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">OutputGlobal: 67.207.67.2 67.207.67.3</span><br><span class="line">. . .</span><br></pre></td></tr></table></figure>

<p>With all of these DNS resolver settings in place, you are now ready to add the peer’s public key to the server, and then start the WireGuard tunnel on the peer.</p>
<h2 id="Step-8-—-Adding-the-Peer’s-Public-Key-to-the-WireGuard-Server"><a href="#Step-8-—-Adding-the-Peer’s-Public-Key-to-the-WireGuard-Server" class="headerlink" title="Step 8 — Adding the Peer’s Public Key to the WireGuard Server"></a>Step 8 — Adding the Peer’s Public Key to the WireGuard Server</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo wg set wg0 peer &lt;client publickey&gt; allowed-ips 10.5.0.2,fd0d:86fa:c3bc::2</span><br></pre></td></tr></table></figure>

<p>This is OK but I think it’s better to modify the server.conf.</p>

  </div>
</article>


    <div class="blog-post-comments">
        <div id="utterances_thread">
            <noscript>Please enable JavaScript to view the comments.</noscript>
        </div>
    </div>


        
          <div id="footer-post-container">
  <div id="footer-post">

    <div id="nav-footer" style="display: none">
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/about/">About</a></li>
         
          <li><a href="/archives/">Articles</a></li>
         
          <li><a href="/friends/">Friends</a></li>
        
      </ul>
    </div>

    <div id="toc-footer" style="display: none">
      <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#Reference"><span class="toc-number">1.</span> <span class="toc-text">Reference</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#TL-DR"><span class="toc-number">2.</span> <span class="toc-text">TL;DR</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Step-1-%E2%80%94-Installing-WireGuard-and-Generating-a-Key-Pair"><span class="toc-number">3.</span> <span class="toc-text">Step 1 — Installing WireGuard and Generating a Key Pair</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Step-2-a-%E2%80%94-Choosing-an-IPv4-Range"><span class="toc-number">3.1.</span> <span class="toc-text">Step 2(a) — Choosing an IPv4 Range</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Step-2-b-%E2%80%94-Choosing-an-IPv6-Range"><span class="toc-number">3.2.</span> <span class="toc-text">Step 2(b) — Choosing an IPv6 Range</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Step-3-%E2%80%94-Creating-a-WireGuard-Server-Configuration"><span class="toc-number">4.</span> <span class="toc-text">Step 3 — Creating a WireGuard Server Configuration</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Step-4-%E2%80%94-Adjusting-the-WireGuard-Server%E2%80%99s-Network-Configuration"><span class="toc-number">5.</span> <span class="toc-text">Step 4 — Adjusting the WireGuard Server’s Network Configuration</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Step-5-%E2%80%94-Configuring-the-WireGuard-Server%E2%80%99s-Firewall"><span class="toc-number">6.</span> <span class="toc-text">Step 5 — Configuring the WireGuard Server’s Firewall</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Step-6-%E2%80%94-Starting-the-WireGuard-Server"><span class="toc-number">7.</span> <span class="toc-text">Step 6 — Starting the WireGuard Server</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Step-7-%E2%80%94-Configuring-a-WireGuard-Peer"><span class="toc-number">8.</span> <span class="toc-text">Step 7 — Configuring a WireGuard Peer</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Creating-the-WireGuard-Peer%E2%80%99s-Key-Pair"><span class="toc-number">8.1.</span> <span class="toc-text">Creating the WireGuard Peer’s Key Pair</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Creating-the-WireGuard-Peer%E2%80%99s-Configuration-File"><span class="toc-number">8.2.</span> <span class="toc-text">Creating the WireGuard Peer’s Configuration File</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Optional-Configuring-a-Peer-to-Route-All-Traffic-Over-the-Tunnel"><span class="toc-number">8.3.</span> <span class="toc-text">(Optional) Configuring a Peer to Route All Traffic Over the Tunnel</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Optional-Configuring-the-WireGuard-Peer%E2%80%99s-DNS-Resolvers"><span class="toc-number">8.4.</span> <span class="toc-text">(Optional) Configuring the WireGuard Peer’s DNS Resolvers</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Step-8-%E2%80%94-Adding-the-Peer%E2%80%99s-Public-Key-to-the-WireGuard-Server"><span class="toc-number">9.</span> <span class="toc-text">Step 8 — Adding the Peer’s Public Key to the WireGuard Server</span></a></li></ol>
    </div>

    <div id="share-footer" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=https://blog.depoze.xyz/2023/01/Setup%20VPN%20via%20wireguard/"><i class="fab fa-facebook fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=https://blog.depoze.xyz/2023/01/Setup%20VPN%20via%20wireguard/&text=Setup VPN via WireGuard"><i class="fab fa-twitter fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=https://blog.depoze.xyz/2023/01/Setup%20VPN%20via%20wireguard/&title=Setup VPN via WireGuard"><i class="fab fa-linkedin fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=https://blog.depoze.xyz/2023/01/Setup%20VPN%20via%20wireguard/&is_video=false&description=Setup VPN via WireGuard"><i class="fab fa-pinterest fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=Setup VPN via WireGuard&body=Check out this article: https://blog.depoze.xyz/2023/01/Setup%20VPN%20via%20wireguard/"><i class="fas fa-envelope fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=https://blog.depoze.xyz/2023/01/Setup%20VPN%20via%20wireguard/&title=Setup VPN via WireGuard"><i class="fab fa-get-pocket fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=https://blog.depoze.xyz/2023/01/Setup%20VPN%20via%20wireguard/&title=Setup VPN via WireGuard"><i class="fab fa-reddit fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=https://blog.depoze.xyz/2023/01/Setup%20VPN%20via%20wireguard/&title=Setup VPN via WireGuard"><i class="fab fa-stumbleupon fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=https://blog.depoze.xyz/2023/01/Setup%20VPN%20via%20wireguard/&title=Setup VPN via WireGuard"><i class="fab fa-digg fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=https://blog.depoze.xyz/2023/01/Setup%20VPN%20via%20wireguard/&name=Setup VPN via WireGuard&description="><i class="fab fa-tumblr fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://news.ycombinator.com/submitlink?u=https://blog.depoze.xyz/2023/01/Setup%20VPN%20via%20wireguard/&t=Setup VPN via WireGuard"><i class="fab fa-hacker-news fa-lg" aria-hidden="true"></i></a></li>
</ul>

    </div>

    <div id="actions-footer">
        <a id="menu" class="icon" href="#" onclick="$('#nav-footer').toggle();return false;"><i class="fas fa-bars fa-lg" aria-hidden="true"></i> Menu</a>
        <a id="toc" class="icon" href="#" onclick="$('#toc-footer').toggle();return false;"><i class="fas fa-list fa-lg" aria-hidden="true"></i> TOC</a>
        <a id="share" class="icon" href="#" onclick="$('#share-footer').toggle();return false;"><i class="fas fa-share-alt fa-lg" aria-hidden="true"></i> Share</a>
        <a id="top" style="display:none" class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fas fa-chevron-up fa-lg" aria-hidden="true"></i> Top</a>
    </div>

  </div>
</div>

        
        <footer id="footer">
  <div class="footer-left">
	Contents are licensed under <a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-sa/4.0/legalcode">CC-BY-SA 4.0</a>.
	<br>
    Copyright &copy;
    
    
    2021-2023
    CuSO4_Deposit
  </div>
  <div class="footer-right">
	Theme <a target="_blank" rel="noopener" href="https://github.com/probberechts/hexo-theme-cactus">Cactus</a>. Powered by Github Pages.
  	<br>
    <nav>
      <ul>
        <!--
       --><li><a href="/">Home</a></li><!--
     --><!--
       --><li><a href="/about/">About</a></li><!--
     --><!--
       --><li><a href="/archives/">Articles</a></li><!--
     --><!--
       --><li><a href="/friends/">Friends</a></li><!--
     -->
      </ul>
    </nav>
  </div>
</footer>

    </div>
    <!-- styles -->



  <link rel="preload" as="style" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.2/css/all.min.css" crossorigin="anonymous" onload="this.onload=null;this.rel='stylesheet'"/>


    <!-- jquery -->
 
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js" crossorigin="anonymous"></script> 




<!-- clipboard -->

  
    <script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.7/clipboard.min.js" crossorigin="anonymous"></script> 
  
  <script type="text/javascript">
  $(function() {
    // copy-btn HTML
    var btn = "<span class=\"btn-copy tooltipped tooltipped-sw\" aria-label=\"Copy to clipboard!\">";
    btn += '<i class="far fa-clone"></i>';
    btn += '</span>'; 
    // mount it!
    $(".highlight table").before(btn);
    var clip = new ClipboardJS('.btn-copy', {
      text: function(trigger) {
        return Array.from(trigger.nextElementSibling.querySelectorAll('.code')).reduce((str,it)=>str+it.innerText+'\n','')
      }
    });
    clip.on('success', function(e) {
      e.trigger.setAttribute('aria-label', "Copied!");
      e.clearSelection();
    })
  })
  </script>


<script src="/js/main.js"></script>

<!-- search -->

<!-- Google Analytics -->

<!-- Baidu Analytics -->

<!-- Cloudflare Analytics -->

<!-- Umami Analytics -->

<!-- Disqus Comments -->

<!-- utterances Comments -->

    <script type="text/javascript">
      var utterances_repo = 'CuSO4Deposit/CuSO4Deposit.github.io';
      var utterances_issue_term = 'url';
      var utterances_label = 'Comment';
      var utterances_theme = 'github-dark';

      (function(){
          var script = document.createElement('script');

          script.src = 'https://utteranc.es/client.js';
          script.setAttribute('repo', utterances_repo);
          script.setAttribute('issue-term', 'pathname');
          script.setAttribute('label', utterances_label);
          script.setAttribute('theme', utterances_theme);
          script.setAttribute('crossorigin', 'anonymous');
          script.async = true;
          (document.getElementById('utterances_thread')).appendChild(script);
      }());
  </script>

</body>
</html>
